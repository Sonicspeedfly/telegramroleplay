# Решение проблемы с квотой Gemini API

## Проблема
```
ERROR - Ошибка при обработке документа: 429 You exceeded your current quota, please check your plan and billing details.
```

## Причины
1. **Бесплатный план** - Ограниченное количество запросов в минуту
2. **Частые запросы** - Слишком много обращений к API
3. **Большие файлы** - Документы с большим количеством токенов

## Решения

### 1. Немедленные исправления в коде
- ✅ Добавлены задержки между запросами
- ✅ Улучшена обработка ошибок квоты
- ✅ Правильная загрузка файлов в Gemini API

### 2. Настройки задержек
```python
# Для документов и изображений
time.sleep(1)  # 1 секунда задержки

# Для обычных сообщений
time.sleep(0.5)  # 0.5 секунды задержки
```

### 3. Обработка ошибок
```python
if "429" in str(e) or "quota" in str(e).lower():
    self.send_message(chat_id, 
        "⚠️ Превышен лимит запросов к Gemini API. Попробуйте через несколько минут.")
```

## Рекомендации

### Для разработки
1. **Используйте тестовые файлы** - Небольшие документы для тестирования
2. **Ограничьте размер файлов** - Максимум 5MB для документов
3. **Добавьте кэширование** - Сохраняйте результаты анализа

### Для продакшена
1. **Перейдите на платный план** - Google AI Studio
2. **Увеличьте лимиты** - Настройте квоты в консоли Google
3. **Используйте очереди** - Обрабатывайте запросы по очереди

## Альтернативные решения

### 1. Использование других моделей
```python
# Попробуйте другие модели Gemini
self.model = genai.GenerativeModel('gemini-1.5-flash')
self.model = genai.GenerativeModel('gemini-1.5-pro')
```

### 2. Локальная обработка
```python
# Для простых документов можно использовать локальную обработку
def simple_text_analysis(text):
    # Простой анализ без обращения к API
    return "Анализ документа: " + text[:200] + "..."
```

### 3. Кэширование результатов
```python
# Сохраняйте результаты анализа в памяти
self.analysis_cache = {}

def get_cached_analysis(file_hash):
    if file_hash in self.analysis_cache:
        return self.analysis_cache[file_hash]
    return None
```

## Мониторинг использования

### Проверка квоты
1. Перейдите в [Google AI Studio](https://makersuite.google.com/app/apikey)
2. Выберите ваш API ключ
3. Проверьте раздел "Usage"

### Логирование
```python
logger.info(f"Запрос к Gemini API: {model_name}")
logger.warning(f"Приближение к лимиту квоты")
logger.error(f"Превышен лимит квоты: {error}")
```

## Планы Google AI Studio

### Бесплатный план
- 15 запросов в минуту
- 1500 запросов в день
- Ограниченные модели

### Платный план
- 60 запросов в минуту
- 15000 запросов в день
- Все модели доступны

## Контакты поддержки
- [Google AI Studio](https://makersuite.google.com/app/apikey)
- [Документация Gemini API](https://ai.google.dev/gemini-api/docs)
- [Лимиты и квоты](https://ai.google.dev/gemini-api/docs/rate-limits) 