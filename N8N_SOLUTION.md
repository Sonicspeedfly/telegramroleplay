# Решение проблемы с квотой на основе логики n8n

## Проблема
```
ERROR - Ошибка при обработке документа: 429 You exceeded your current quota, please check your plan and billing details.
```

## Решение на основе n8n

### 1. Использование правильной модели
```python
# ✅ Экономичная модель (как в n8n)
self.model = genai.GenerativeModel('gemini-1.5-flash')

# ❌ Дорогая модель
self.model = genai.GenerativeModel('gemini-2.5-pro')
```

### 2. Правильная обработка файлов
```python
# ✅ Правильный способ
response = self.model.generate_content(context_text)

# ❌ Неправильный способ
file_bytes = io.BytesIO(file_content)
response = self.model.generate_content([context_text, file_bytes])
```



### 3. Увеличенные задержки
```python
# ✅ Длительные задержки (как в n8n)
time.sleep(3)  # Для документов и изображений
time.sleep(2)  # Для обычных сообщений

# ❌ Короткие задержки
time.sleep(1)
time.sleep(0.5)
```

### 4. Ограничение размера файлов
```python
# ✅ Меньший размер файлов
if file_size > 10 * 1024 * 1024:  # 10MB
    self.send_message(chat_id, "❌ Файл слишком большой. Максимальный размер: 10MB")

# ❌ Больший размер файлов
if file_size > 20 * 1024 * 1024:  # 20MB
```

## Преимущества подхода n8n

### 1. Экономия токенов
- `gemini-1.5-flash` дешевле чем `gemini-2.5-pro`
- Меньшие файлы = меньше токенов
- Правильная обработка файлов

### 2. Стабильность
- Длительные задержки предотвращают превышение квоты
- Правильная обработка ошибок
- Корректные типы данных

### 3. Совместимость
- Использование стандартных типов Gemini API
- Поддержка всех форматов файлов
- Надежная обработка ошибок

## Сравнение моделей

### gemini-1.5-flash (рекомендуется)
- ✅ Быстрая
- ✅ Экономичная
- ✅ Стабильная
- ✅ Подходит для большинства задач

### gemini-2.5-pro (не рекомендуется для бесплатного плана)
- ❌ Дорогая
- ❌ Медленная
- ❌ Легко превышает квоту
- ❌ Избыточна для простых задач

## Рекомендации

### Для разработки:
1. Используйте `gemini-1.5-flash`
2. Ограничьте размер файлов до 10MB
3. Добавьте задержки 2-3 секунды
4. Используйте правильные типы данных

### Для продакшена:
1. Рассмотрите платный план
2. Используйте очереди запросов
3. Добавьте кэширование
4. Мониторьте использование квоты

## Мониторинг

### Проверка квоты:
1. [Google AI Studio](https://makersuite.google.com/app/apikey)
2. Выберите API ключ
3. Проверьте раздел "Usage"

### Логирование:
```python
logger.info(f"Запрос к Gemini API: {model_name}")
logger.warning(f"Приближение к лимиту квоты")
logger.error(f"Превышен лимит квоты: {error}")
```

## Контакты
- [Google AI Studio](https://makersuite.google.com/app/apikey)
- [Документация Gemini API](https://ai.google.dev/gemini-api/docs)
- [Лимиты и квоты](https://ai.google.dev/gemini-api/docs/rate-limits) 