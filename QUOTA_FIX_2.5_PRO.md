# Решение проблемы с квотой для gemini-2.5-pro

## Проблема
```
ERROR - Ошибка при обработке документа: 429 You exceeded your current quota, please check your plan and billing details.
```

## Решение для gemini-2.5-pro

### 1. Увеличенные задержки
```python
# ✅ Длительные задержки для gemini-2.5-pro
time.sleep(10)  # Для документов и изображений
time.sleep(5)   # Для обычных сообщений

# ❌ Короткие задержки
time.sleep(3)
time.sleep(2)
```

### 2. Ограничение размера файлов
```python
# ✅ Меньший размер файлов
if file_size > 5 * 1024 * 1024:  # 5MB
    self.send_message(chat_id, "❌ Файл слишком большой. Максимальный размер: 5MB")

# ❌ Больший размер файлов
if file_size > 10 * 1024 * 1024:  # 10MB
```

### 3. Ограничение размера текста
```python
# ✅ Ограничение текста документа
max_text_length = 2000  # Ограничиваем до 2000 символов
if len(document_text) > max_text_length:
    document_text = document_text[:max_text_length] + "..."
```

### 4. Уменьшение истории чата
```python
# ✅ Меньшая история
if len(session['chat_history']) > 10:
    session['chat_history'] = session['chat_history'][-10:]

# ❌ Большая история
if len(session['chat_history']) > 20:
    session['chat_history'] = session['chat_history'][-20:]
```

### 5. Краткие запросы
```python
# ✅ Краткий запрос
context_text += "Нейкон, проанализируй этот документ и дай краткий ответ с рекомендациями."

# ❌ Подробный запрос
context_text += "Нейкон, проанализируй этот документ и дай подробный ответ с рекомендациями."
```

## Сравнение настроек

### Для gemini-1.5-flash (экономичная модель):
- Задержки: 2-3 секунды
- Размер файлов: 10MB
- История: 20 сообщений
- Текст: без ограничений

### Для gemini-2.5-pro (дорогая модель):
- Задержки: 5-10 секунд
- Размер файлов: 5MB
- История: 10 сообщений
- Текст: 2000 символов

## Рекомендации

### Для разработки с gemini-2.5-pro:
1. **Используйте длительные задержки** - 5-10 секунд
2. **Ограничивайте размер файлов** - максимум 5MB
3. **Сокращайте текст** - максимум 2000 символов
4. **Уменьшайте историю** - максимум 10 сообщений
5. **Используйте краткие запросы** - избегайте подробных инструкций

### Для продакшена:
1. **Рассмотрите платный план** - для увеличения лимитов
2. **Используйте очереди** - для обработки запросов
3. **Добавьте кэширование** - для повторных запросов
4. **Мониторьте использование** - следите за квотой

## Мониторинг квоты

### Проверка использования:
1. [Google AI Studio](https://makersuite.google.com/app/apikey)
2. Выберите API ключ
3. Проверьте раздел "Usage"

### Лимиты бесплатного плана:
- **gemini-2.5-pro**: 250,000 токенов в минуту
- **gemini-1.5-flash**: 1,000,000 токенов в минуту

## Альтернативные решения

### 1. Переход на gemini-1.5-flash
```python
self.model = genai.GenerativeModel('gemini-1.5-flash')
```

### 2. Использование платного плана
- Увеличенные лимиты
- Приоритетная поддержка
- Дополнительные модели

### 3. Кэширование результатов
```python
# Сохраняйте результаты анализа
self.analysis_cache = {}

def get_cached_analysis(file_hash):
    if file_hash in self.analysis_cache:
        return self.analysis_cache[file_hash]
    return None
```

## Заключение
Для gemini-2.5-pro необходимо использовать более агрессивные ограничения для избежания превышения квоты. Рекомендуется использовать длительные задержки и ограничивать размеры файлов и текста. 